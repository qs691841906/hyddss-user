<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sinosoft.ddss.dao.OrderInfoMapper">
	<resultMap id="BaseResultMap" type="com.sinosoft.ddss.common.entity.OrderInfo">
		<!-- WARNING - @mbg.generated This element is automatically generated by 
			MyBatis Generator, do not modify. -->
		<id column="order_id" property="orderId" />
		<result column="order_main_id" property="orderMainId" />
		<result column="order_type" property="orderType" />
		<result column="order_flag" property="orderFlag" />
		<result column="create_time" property="createTime" />
		<result column="priority" property="priority" />
		<result column="data_id" property="dataId" />
		<result column="in_product_level" property="inProductLevel" />
		<result column="out_product_level" property="outProductLevel" />
		<result column="satellite" property="satellite" />
		<result column="sensor" property="sensor" />
		<result column="cloud_coverage" property="cloudCoverage" />
		<result column="product_name" property="productName" />
		<result column="data_size" property="dataSize" />
		<result column="data_unit" property="dataUnit" />
		<result column="batch_no" property="batchNo" />
		<result column="order_status" property="orderStatus" />
		<result column="download_status" property="downloadStatus" />
		<result column="distribution_status" property="distributionStatus" />
		<result column="cancel_status" property="cancelStatus" />
		<result column="order_fail_reason" property="orderFailReason" />
		<result column="pro_download_add" property="proDownloadAdd" />
		<result column="rep_download_add" property="repDownloadAdd" />
		<result column="user_name" property="userName" />
		<result column="user_unit" property="userUnit" />
		<result column="work_type" property="workType" />
		<result column="produce_time" property="produceTime" />
		<result column="order_step" property="orderStep" />
		<result column="ftp_url" property="ftpUrl" />
	</resultMap>
	<resultMap type="com.sinosoft.ddss.common.entity.query.OrderInfoQuery" id="OrderInfoQuery">
		<result column="order_status" property="orderStatus" />
		<result column="order_count" property="orderCount" />
	</resultMap>
	<sql id="Base_Column_List">
		<!-- WARNING - @mbg.generated This element is automatically generated by 
			MyBatis Generator, do not modify. -->
		order_id, order_main_id, order_type, order_flag,
		to_char(create_time, 'yyyy/MM/dd HH24:mi:ss') create_time,
		to_char(produce_time, 'yyyy/MM/dd HH24:mi:ss') produce_time,
		priority, data_id,
		in_product_level, out_product_level, satellite, sensor,
		cloud_coverage, product_name,
		data_size, data_unit, batch_no,
		order_status, download_status,
		distribution_status, cancel_status,
		order_fail_reason,pro_download_add,rep_download_add,user_name,user_unit,work_type,order_step,ftp_url
	</sql>
	<select id="selectByPrimaryKey" parameterType="java.math.BigDecimal"
		resultMap="BaseResultMap">
		<!-- WARNING - @mbg.generated This element is automatically generated by 
			MyBatis Generator, do not modify. -->
		select
		<include refid="Base_Column_List" />
		from ddss_orderinfo
		where order_id = #{orderId}
	</select>
	<delete id="deleteByPrimaryKey" parameterType="java.math.BigDecimal">
		<!-- WARNING - @mbg.generated This element is automatically generated by 
			MyBatis Generator, do not modify. -->
		delete from ddss_orderinfo
		where order_id = #{orderId}
	</delete>
	<insert id="insert" parameterType="com.sinosoft.ddss.common.entity.OrderInfo">
		<!-- WARNING - @mbg.generated This element is automatically generated by 
			MyBatis Generator, do not modify. -->
		insert into ddss_orderinfo (order_id, order_main_id, order_type,
		order_flag, create_time, priority,
		data_id, in_product_level,
		out_product_level,
		satellite, sensor, cloud_coverage,
		product_name,
		data_size, data_unit,
		batch_no, order_status, download_status,
		distribution_status, cancel_status, order_fail_reason
		)
		values
		(#{orderId}, #{orderMainId},
		#{orderType},
		#{orderFlag},
		#{createTime}, #{priority},
		#{dataId}, #{inProductLevel},
		#{outProductLevel},
		#{satellite},
		#{sensor}, #{cloudCoverage},
		#{productName}, #{dataSize},
		#{dataUnit},
		#{batchNo},
		#{orderStatus},
		#{downloadStatus},
		#{distributionStatus},
		#{cancelStatus}, #{orderFailReason}
		)
	</insert>
	<insert id="insertSelective" parameterType="com.sinosoft.ddss.common.entity.OrderInfo">
		<!-- WARNING - @mbg.generated This element is automatically generated by 
			MyBatis Generator, do not modify. -->
		insert into ddss_orderinfo
		<trim prefix="(" suffix=")" suffixOverrides=",">
			<if test="orderId != null">
				order_id,
			</if>
			<if test="orderMainId != null">
				order_main_id,
			</if>
			<if test="orderType != null">
				order_type,
			</if>
			<if test="orderFlag != null">
				order_flag,
			</if>
			<if test="priority != null">
				priority,
			</if>
			<if test="dataId != null">
				data_id,
			</if>
			<if test="inProductLevel != null">
				in_product_level,
			</if>
			<if test="outProductLevel != null">
				out_product_level,
			</if>
			<if test="satellite != null">
				satellite,
			</if>
			<if test="sensor != null">
				sensor,
			</if>
			<if test="cloudCoverage != null">
				cloud_coverage,
			</if>
			<if test="productName != null">
				product_name,
			</if>
			<if test="dataSize != null">
				data_size,
			</if>
			<if test="dataUnit != null">
				data_unit,
			</if>
			<if test="batchNo != null">
				batch_no,
			</if>
			<if test="orderStatus != null">
				order_status,
			</if>
			<if test="downloadStatus != null">
				download_status,
			</if>
			<if test="distributionStatus != null">
				distribution_status,
			</if>
			<if test="cancelStatus != null">
				cancel_status,
			</if>
			<if test="orderFailReason != null">
				order_fail_reason,
			</if>
			<if test="ftpUrl != null">
				ftp_url,
			</if>
		</trim>
		<trim prefix="values (" suffix=")" suffixOverrides=",">
			<if test="orderId != null">
				#{orderId},
			</if>
			<if test="orderMainId != null">
				#{orderMainId},
			</if>
			<if test="orderType != null">
				#{orderType},
			</if>
			<if test="orderFlag != null">
				#{orderFlag},
			</if>
			<if test="priority != null">
				#{priority},
			</if>
			<if test="dataId != null">
				#{dataId},
			</if>
			<if test="inProductLevel != null">
				#{inProductLevel},
			</if>
			<if test="outProductLevel != null">
				#{outProductLevel},
			</if>
			<if test="satellite != null">
				#{satellite},
			</if>
			<if test="sensor != null">
				#{sensor},
			</if>
			<if test="cloudCoverage != null">
				#{cloudCoverage},
			</if>
			<if test="productName != null">
				#{productName},
			</if>
			<if test="dataSize != null">
				#{dataSize},
			</if>
			<if test="dataUnit != null">
				#{dataUnit},
			</if>
			<if test="batchNo != null">
				#{batchNo},
			</if>
			<if test="orderStatus != null">
				#{orderStatus},
			</if>
			<if test="downloadStatus != null">
				#{downloadStatus},
			</if>
			<if test="distributionStatus != null">
				#{distributionStatus},
			</if>
			<if test="cancelStatus != null">
				#{cancelStatus},
			</if>
			<if test="orderFailReason != null">
				#{orderFailReason},
			</if>
			<if test="ftpUrl != null">
				#{ftpUrl},
			</if>
		</trim>
	</insert>
	<update id="updateByPrimaryKeySelective" parameterType="com.sinosoft.ddss.common.entity.OrderInfo">
		<!-- WARNING - @mbg.generated This element is automatically generated by 
			MyBatis Generator, do not modify. -->
		update ddss_orderinfo
		<set>
			<if test="outProductLevel != null">
				out_product_level = #{outProductLevel},
			</if>
			<if test="cloudCoverage != null">
				cloud_coverage = #{cloudCoverage},
			</if>
			<if test="productName != null">
				product_name = #{productName},
			</if>
			<if test="dataSize != null">
				data_size = #{dataSize},
			</if>
			<if test="dataUnit != null">
				data_unit = #{dataUnit},
			</if>
			<if test="batchNo != null">
				batch_no = #{batchNo},
			</if>
			<if test="orderStatus != null">
				order_status = #{orderStatus},
			</if>
			<if test="downloadStatus != null">
				download_status = #{downloadStatus},
			</if>
		</set>
		where order_id = #{orderId}
	</update>
	<update id="updateByPrimaryKey" parameterType="com.sinosoft.ddss.common.entity.OrderInfo">
		<!-- WARNING - @mbg.generated This element is automatically generated by 
			MyBatis Generator, do not modify. -->
		update ddss_orderinfo
		set order_main_id =
		#{orderMainId},
		order_type =
		#{orderType},
		order_flag =
		#{orderFlag},
		create_time =
		#{createTime},
		priority =
		#{priority},
		data_id = #{dataId},
		in_product_level = #{inProductLevel},
		out_product_level = #{outProductLevel},
		satellite =
		#{satellite},
		sensor = #{sensor},
		cloud_coverage = #{cloudCoverage},
		product_name =
		#{productName},
		data_size =
		#{dataSize},
		data_unit = #{dataUnit},
		batch_no = #{batchNo},
		order_status =
		#{orderStatus},
		download_status =
		#{downloadStatus},
		distribution_status =
		#{distributionStatus},
		cancel_status =
		#{cancelStatus},
		order_fail_reason =
		#{orderFailReason}
		where order_id =
		#{orderId}
	</update>

	<select id="getOrderSeq" resultType="Long">
		select
		nextval('ddss_order_seq');
	</select>

	<!-- 批量新增子订单 -->
	<insert id="saveOrder" parameterType="java.util.List">
		<if test="list != null and list.size() > 0">
			<foreach collection="list" item="item" separator=";">
				insert into ddss_orderinfo
				<trim prefix="(" suffix=")" suffixOverrides=",">
					<if test="item.orderId != null and item.orderId != ''">
						order_id,
					</if>
					<if test="item.orderMainId != null and item.orderMainId != ''">
						order_main_id,
					</if>
					<if test="item.orderType != null and item.orderType != ''">
						order_type,
					</if>
					<if test="item.orderFlag != null and item.orderFlag != ''">
						order_flag,
					</if>
					<if test="item.priority != null and item.priority != ''">
						priority,
					</if>
					<if test="item.dataId != null and item.dataId != ''">
						data_id,
					</if>
					<if test="item.inProductLevel != null and item.inProductLevel != ''">
						in_product_level,
					</if>
					<if test="item.outProductLevel != null and item.outProductLevel != ''">
						out_product_level,
					</if>
					<if test="item.satellite != null and item.satellite != ''">
						satellite,
					</if>
					<if test="item.sensor != null and item.sensor != ''">
						sensor,
					</if>
					<if test="item.cloudCoverage != null and item.cloudCoverage != ''">
						cloud_coverage,
					</if>
					<if test="item.productName != null and item.productName != ''">
						product_name,
					</if>
					<if test="item.dataSize != null and item.dataSize != ''">
						data_size,
					</if>
					<if test="item.dataUnit != null and item.dataUnit != ''">
						data_unit,
					</if>
					<if test="item.batchNo != null and item.batchNo != ''">
						batch_no,
					</if>
					<if test="item.orderStatus != null and item.orderStatus != ''">
						order_status,
					</if>
					<if test="item.downloadStatus != null and item.downloadStatus != ''">
						download_status,
					</if>
					<if test="item.distributionStatus != null and item.distributionStatus != ''">
						distribution_status,
					</if>
					<if test="item.orderFailReason != null and item.orderFailReason != ''">
						order_fail_reason,
					</if>
					<if test="item.proDownloadAdd != null and item.proDownloadAdd != ''">
						pro_download_add,
					</if>
					<if test="item.repDownloadAdd != null and item.repDownloadAdd != ''">
						rep_download_add,
					</if>
					<if test="item.userName != null and item.userName != ''">
						user_name,
					</if>
					<if test="item.userUnit != null and item.userUnit != ''">
						user_unit,
					</if>
					<if test="item.workType != null and item.workType != ''">
						work_type,
					</if>
					<if test="item.ftpUrl != null and item.ftpUrl != ''">
						ftp_url,
					</if>
					order_step
				</trim>
				<trim prefix="values (" suffix=")" suffixOverrides=",">
					<if test="item.orderId != null and item.orderId != ''">
						#{item.orderId},
					</if>
					<if test="item.orderMainId != null and item.orderMainId != ''">
						#{item.orderMainId},
					</if>
					<if test="item.orderType != null and item.orderType != ''">
						#{item.orderType},
					</if>
					<if test="item.orderFlag != null and item.orderFlag != ''">
						#{item.orderFlag},
					</if>
					<if test="item.priority != null and item.priority != ''">
						#{item.priority},
					</if>
					<if test="item.dataId != null and item.dataId != ''">
						#{item.dataId},
					</if>
					<if test="item.inProductLevel != null and item.inProductLevel != ''">
						#{item.inProductLevel},
					</if>
					<if test="item.outProductLevel != null and item.outProductLevel != ''">
						#{item.outProductLevel},
					</if>
					<if test="item.satellite != null and item.satellite != ''">
						#{item.satellite},
					</if>
					<if test="item.sensor != null and item.sensor != ''">
						#{item.sensor},
					</if>
					<if test="item.cloudCoverage != null and item.cloudCoverage != ''">
						#{item.cloudCoverage},
					</if>
					<if test="item.productName != null and item.productName != ''">
						#{item.productName},
					</if>
					<if test="item.dataSize != null and item.dataSize != ''">
						#{item.dataSize},
					</if>
					<if test="item.dataUnit != null and item.dataUnit != ''">
						#{item.dataUnit},
					</if>
					<if test="item.batchNo != null and item.batchNo != ''">
						#{item.batchNo},
					</if>
					<if test="item.orderStatus != null and item.orderStatus != ''">
						#{item.orderStatus},
					</if>
					<if test="item.downloadStatus != null and item.downloadStatus != ''">
						#{item.downloadStatus},
					</if>
					<if test="item.distributionStatus != null and item.distributionStatus != ''">
						#{item.distributionStatus},
					</if>
					<if test="item.orderFailReason != null and item.orderFailReason != ''">
						#{item.orderFailReason},
					</if>
					<if test="item.proDownloadAdd != null and item.proDownloadAdd != ''">
						#{item.proDownloadAdd},
					</if>
					<if test="item.repDownloadAdd != null and item.repDownloadAdd != ''">
						#{item.repDownloadAdd},
					</if>
					<if test="item.userName != null and item.userName != ''">
						#{item.userName},
					</if>
					<if test="item.userUnit != null and item.userUnit != ''">
						#{item.userUnit},
					</if>
					<if test="item.workType != null and item.workType != ''">
						#{item.workType},
					</if>
					<if test="item.ftpUrl != null and item.ftpUrl != ''">
						#{item.ftpUrl},
					</if>
					'1_' || to_char(now(), 'yyyy-mm-dd HH24:mi:ss')
				</trim>
			</foreach>
		</if>
	</insert>
	<select id="getOrderInfoByOrderMainId"
		parameterType="com.sinosoft.ddss.common.entity.query.OrderInfoQuery"
		resultMap="BaseResultMap">
		select
		<include refid="Base_Column_List" />
		from ddss_orderinfo
		<trim prefix="WHERE" prefixOverrides="AND | OR">
			<if test="userName != null and userName != ''">
				AND user_name = #{userName}
			</if>
			<if test="outProductLevel != null and outProductLevel != ''">
				AND out_product_level = #{outProductLevel}
			</if>
			<if test="satellite != null and satellite != ''">
				AND satellite = #{satellite}
			</if>
			<if test="sensor != null and sensor != ''">
				AND sensor = #{sensor}
			</if>
			<if test="orderId != null and orderId != ''">
				AND order_id = #{orderId}
			</if>
			<if test="orderStatus != null and orderStatus != ''">
				AND order_status = #{orderStatus}
			</if>
			<if test="batchNos != null and batchNos != ''">
				AND ${batchNos}
			</if>
			AND order_main_id = #{orderMainId}
			ORDER BY batch_no
		</trim>
		<if test="startNum != null and startNum >= 0 and pageSize != null and pageSize > 0">
			<![CDATA[ limit #{pageSize} offset #{startNum} ]]>
		</if>
	</select>
	<select id="getOrderInfoByOrderMainIdNoPage"
		parameterType="com.sinosoft.ddss.common.entity.query.OrderInfoQuery"
		resultMap="BaseResultMap">
		select
		<include refid="Base_Column_List" />
		from ddss_orderinfo
		where order_main_id = #{orderMainId}
	</select>
	<!-- 根据订单状态统计 -->
	<select id="statisticalOrderByStatus"
		parameterType="com.sinosoft.ddss.common.entity.query.OrderInfoQuery"
		resultMap="OrderInfoQuery">
		select
		order_status, count(1) as order_count
		from
		ddss_orderinfo
		<trim prefix="WHERE" prefixOverrides="AND | OR">
			<if test="userName != null and userName != ''">
				AND user_name = #{userName}
			</if>
			<if test="outProductLevel != null and outProductLevel != ''">
				AND out_product_level = #{outProductLevel}
			</if>
			<if test="satellite != null and satellite != ''">
				AND satellite = #{satellite}
			</if>
			<if test="sensor != null and sensor != ''">
				AND sensor = #{sensor}
			</if>
			<if test="orderId != null and orderId != ''">
				AND order_id = #{orderId}
			</if>
			<if test="orderStatus != null and orderStatus != ''">
				AND order_status = #{orderStatus}
			</if>
			<if test="batchNos != null and batchNos != ''">
				AND #{batchNos}
			</if>
			AND order_main_id = #{orderMainId}
		</trim>
		GROUP BY
		order_status
	</select>
	<!-- 修改订单状态 -->
	<update id="updateOrderStatus" parameterType="map">
		update ddss_orderinfo
		<set>
			<if test="orderStatus != null and orderStatus != ''">
				order_status = to_number(#{orderStatus}, '99999'),
			</if>
			<if test="failReason != null and failReason != ''">
				order_fail_reason = #{failReason},
			</if>
			<if test="auditor != null and auditor != ''">
				auditor = #{auditor},
			</if>
		</set>
		where
		<choose>
			<when test="flag != null and flag != ''">
				<if test="flag == 1">
					order_main_id in (${orderId})
				</if>
				<if test="flag == 2">
					order_id in (${orderId})
				</if>
			</when>
			<otherwise>
				 and 1=1
			</otherwise>
		</choose>
	</update>
	<!--根据主订单和子订单id查询子订单信息(返回List<Map<String, Object>>) -->
	<select id="findSonOrderByCond" resultType="Map" parameterType="Map">
		SELECT
		info.*
		FROM ddss_orderinfo info
		WHERE 1=1
		<if test="orderMainId != null and orderMainId.trim() != ''">
			AND info.order_main_id = ${orderMainId}
		</if>
	</select>
	<select id="getOrderInfoById" parameterType="Long" resultMap="BaseResultMap">
		select
		<include refid="Base_Column_List" />
		from ddss_orderinfo
		where order_id = ${_parameter}
	</select>
	
	<select id="hotData" resultMap="BaseResultMap">
		SELECT
		data_id AS data_id,
		product_name AS product_name,
		satellite AS
		satellite,
		sensor AS sensor,
		out_product_level AS out_product_level,
		to_char(
		produce_time,
		'yyyy/MM/dd HH24:mi:ss'
		) produce_time,
		COUNT(data_id) AS countdata
		FROM
		ddss_orderinfo
		WHERE
		create_time > (
		SELECT
		CURRENT_TIMESTAMP - INTERVAL '1 month'
		)
		and order_type = 1
		GROUP BY
		data_id,
		product_name,
		satellite,
		sensor,
		out_product_level,
		produce_time
		ORDER BY countdata DESC
		LIMIT 10
	</select>
	
	<select id="getOrderCountByQuery" resultType="java.lang.Integer"
		parameterType="com.sinosoft.ddss.common.entity.query.OrderInfoQuery">
		select count(*) from ddss_orderinfo
		<trim prefix="WHERE" prefixOverrides="AND | OR">
			<if test="userName != null and userName != ''">
				AND user_name = #{userName}
			</if>
			<if test="orderMainId != null and orderMainId != ''">
				AND order_main_id = #{orderMainId}
			</if>
			<if test="orderId != null and orderId != ''">
				AND order_id = #{orderId}
			</if>
			<if test="orderType != null and orderType != ''">
				AND order_type = #{orderType}
			</if>
			<if test="orderStatus != null and orderStatus != ''">
				AND order_status = #{orderStatus}
			</if>
			<if test="outProductLevel != null and outProductLevel != ''">
				AND out_product_level = #{outProductLevel}
			</if>
			<if test="satellite != null and satellite != ''">
				AND satellite = #{satellite}
			</if>
			<if test="sensor != null and sensor != ''">
				AND sensor = #{sensor}
			</if>
		</trim>
	</select>
	
	<select id="getSatisfactionOrderList">
		SELECT
			di.*,dm.distribution_type
		FROM
			ddss_orderinfo di
		LEFT JOIN ddss_orderinfo_main dm ON di.order_main_id = dm.order_main_id
		WHERE
			di.download_status != 4
		AND dm.distribution_type = 1
		AND (di.order_status != 5 AND di.order_status != 6)
		AND di.order_type = #{orderType}
		AND data_id = #{dataId}
		<if test="outProductLevel != null and outProductLevel''">
			AND out_product_level = #{outProductLevel}
		</if>
		ORDER BY di.download_status DESC,di.create_time
	</select>
	
	<!-- 查询订单数据 -->
	<select id="queryCallPolice" resultMap="BaseResultMap" parameterType="java.util.Map">
		SELECT order_id FROM ddss_orderinfo
		WHERE (create_time &lt; (SELECT current_timestamp - interval '${orderWaringTime} hour') AND ${orderMainIds})
	</select>
	
	<!-- 根据dataid等条件查询待分发和已完成的订单，按时间倒叙 -->
	<select id="getOrderInfoByDataId"
		parameterType="com.sinosoft.ddss.common.entity.query.OrderInfoQuery"
		resultMap="BaseResultMap">
		select
		<include refid="Base_Column_List" />
		from ddss_orderinfo
		<trim prefix="WHERE" prefixOverrides="AND | OR">
			<if test="dataId !=null and dataId !=''">
				AND data_id = #{dataId}
			</if>
			<if test="outProductLevel !=null and outProductLevel !=''">
				AND out_product_level = #{outProductLevel}
			</if>
			<if test="orderStatus !=null and orderStatus =='-1'">
				AND order_status in (3,4)
			</if>
			<if test="orderStatus !=null and orderStatus !='' and orderStatus !='-1' ">
				AND order_status = #{orderStatus}
			</if>

		</trim>
		ORDER BY create_time DESC
	</select>
</mapper>